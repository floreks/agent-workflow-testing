services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    volumes:
    - db-data:/var/lib/postgresql/data
    ports:
    - "5432:5432"

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: app
      DB_PASSWORD: app
      DB_NAME: app
      DB_SSLMODE: disable
      APP_ADDR: :8080
    volumes:
    - ./:/app
    depends_on:
    - db
    ports:
    - "8080:8080"

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    working_dir: /app/frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
    command: sh -c "npm ci && npm run dev"
    volumes:
    - ./frontend/src:/app/frontend/src
    - ./frontend/index.html:/app/frontend/index.html
    - ./frontend/vite.config.js:/app/frontend/vite.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - frontend-node-modules:/app/frontend/node_modules
    ports:
    - "5173:5173"

  nginx:
    image: nginx:1.27
    volumes:
    - ./nginx/dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    ports:
    - "8088:80"

  playwright:
    image: mcr.microsoft.com/playwright:v1.57.0
    working_dir: /app/frontend
    command: sh -c "npm ci && npx playwright install --with-deps chrome && npx playwright install --with-deps msedge && npx playwright test"
    profiles:
    - playwright
    depends_on:
    - nginx
    environment:
      PLAYWRIGHT_BASE_URL: http://nginx
      PLAYWRIGHT_OUTPUT_DIR: /tmp/playwright-results
    volumes:
    - ./frontend/e2e/playwright/default:/app/frontend/e2e/playwright/default
    - ./frontend/playwright.config.js:/app/frontend/playwright.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - playwright-node-modules:/app/frontend/node_modules
    - playwright-results:/tmp/playwright-results

  cypress:
    image: cypress/browsers:24.13.0
    working_dir: /app/frontend
    command: sh -c "npm ci && npx cypress run --config baseUrl=http://nginx"
    profiles:
    - cypress
    depends_on:
    - nginx
    volumes:
    - ./frontend/e2e/cypress:/app/frontend/e2e/cypress
    - ./frontend/cypress.config.js:/app/frontend/cypress.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - cypress-node-modules:/app/frontend/node_modules

  ### Host-level containers to simulate remote browser environments

  chrome:
    image: ghcr.io/browserless/chrome:v2.38.4
    network_mode: host
    profiles:
    - chrome
    - e2e-playwright-remote

  chromium:
    image: ghcr.io/browserless/chromium:v2.38.4
    network_mode: host
    profiles:
    - chromium
    - e2e-puppeteer-remote

  selenium-browser:
    image: selenium/standalone-chrome:latest
    network_mode: host
    environment:
      SE_OPTS: "--port 3000"
    profiles:
    - selenium-browser
    - e2e-selenium-remote

  e2e-playwright-remote:
    image: node:25
    network_mode: host
    working_dir: /app/frontend
    command: sh -c "npm ci && npm run test:e2e:playwright:remote"
    environment:
      PLAYWRIGHT_WS_ENDPOINT: ws://localhost:3000/chrome/playwright
      PLAYWRIGHT_BASE_URL: http://localhost:8088
    profiles:
    - e2e-playwright-remote
    depends_on:
    - nginx
    #    - chrome
    volumes:
    - ./frontend/e2e/playwright/remote:/app/frontend/e2e/playwright/remote
    - ./frontend/playwright.remote.config.js:/app/frontend/playwright.remote.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - playwright-node-modules:/app/frontend/node_modules
    - playwright-results:/tmp/playwright-results

  e2e-puppeteer-remote:
    image: node:25
    network_mode: host
    working_dir: /app/frontend
    command: sh -c "npm ci && npm run test:e2e:puppeteer:remote"
    environment:
      PUPPETEER_WS_ENDPOINT: ws://localhost:3000
      PUPPETEER_BASE_URL: http://localhost:8088
    profiles:
    - e2e-puppeteer-remote
    depends_on:
    - nginx
    #    - chromium
    volumes:
    - ./frontend/e2e/puppeteer:/app/frontend/e2e/puppeteer
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - puppeteer-node-modules:/app/frontend/node_modules

  e2e-selenium-remote:
    image: node:25
    working_dir: /app/frontend
    command: sh -c "npm ci && npm run test:e2e:selenium:remote"
    environment:
      SELENIUM_REMOTE_URL: http://localhost:3000
      SELENIUM_BASE_URL: http://localhost:8088
    profiles:
    - e2e-selenium-remote
    depends_on:
    - nginx
    #    - selenium-browser
    network_mode: host
    volumes:
    - ./frontend/e2e/selenium:/app/frontend/e2e/selenium
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - selenium-node-modules:/app/frontend/node_modules

volumes:
  db-data:
  frontend-node-modules:
  playwright-node-modules:
  playwright-results:
  cypress-node-modules:
  selenium-node-modules:
  puppeteer-node-modules:
