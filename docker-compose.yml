services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    volumes:
    - db-data:/var/lib/postgresql/data
    ports:
    - "5432:5432"

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/health"]
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: app
      DB_PASSWORD: app
      DB_NAME: app
      DB_SSLMODE: disable
      APP_ADDR: :8080
    volumes:
    - ./:/app
    depends_on:
    - db
    ports:
    - "8080:8080"

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    working_dir: /app/frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5173"]
    command: sh -c "npm ci && npm run dev"
    volumes:
    - ./frontend/src:/app/frontend/src
    - ./frontend/index.html:/app/frontend/index.html
    - ./frontend/vite.config.js:/app/frontend/vite.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - frontend-node-modules:/app/frontend/node_modules
    ports:
    - "5173:5173"

  nginx:
    image: nginx:1.27
    volumes:
    - ./nginx/dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    ports:
    - "8088:80"

  browserless:
    image: browserless/chrome:latest
    profiles:
    - remote
    environment:
      MAX_CONCURRENT_SESSIONS: 1
      PREBOOT_CHROME: true
    ports:
    - "3000:3000"

  playwright:
    image: mcr.microsoft.com/playwright:v1.58.0-jammy
    working_dir: /app/frontend
    command: sh -c "npm ci && npx playwright install --with-deps chrome && npx playwright install --with-deps msedge && npx playwright test"
    profiles:
    - playwright
    depends_on:
    - nginx
    environment:
      PLAYWRIGHT_BASE_URL: http://nginx
      PLAYWRIGHT_OUTPUT_DIR: /tmp/playwright-results
    volumes:
    - ./frontend/tests:/app/frontend/tests
    - ./frontend/playwright.config.js:/app/frontend/playwright.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - playwright-node-modules:/app/frontend/node_modules
    - playwright-results:/tmp/playwright-results

  cypress:
    image: cypress/browsers:24.13.0
    working_dir: /app/frontend
    command: sh -c "npm ci && npx cypress run --config baseUrl=http://nginx"
    profiles:
    - cypress
    depends_on:
    - nginx
    volumes:
    - ./frontend/cypress:/app/frontend/cypress
    - ./frontend/cypress.config.js:/app/frontend/cypress.config.js
    - ./frontend/package.json:/app/frontend/package.json
    - ./frontend/package-lock.json:/app/frontend/package-lock.json
    - cypress-node-modules:/app/frontend/node_modules

volumes:
  db-data:
  frontend-node-modules:
  playwright-node-modules:
  playwright-results:
  cypress-node-modules:
