services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: app
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_USER: app
      DB_PASSWORD: app
      DB_NAME: app
      DB_SSLMODE: disable
      APP_ADDR: :8080
    volumes:
      - ./:/app
    depends_on:
      - db
    ports:
      - "8080:8080"

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    working_dir: /app/frontend
    command: sh -c "npm ci && npm run dev"
    volumes:
      - ./frontend/src:/app/frontend/src
      - ./frontend/index.html:/app/frontend/index.html
      - ./frontend/vite.config.js:/app/frontend/vite.config.js
      - ./frontend/package.json:/app/frontend/package.json
      - ./frontend/package-lock.json:/app/frontend/package-lock.json
      - frontend-node-modules:/app/frontend/node_modules
    ports:
      - "5173:5173"

  nginx:
    image: nginx:1.27
    volumes:
      - ./nginx/dev.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - backend
    ports:
      - "8088:80"

  playwright:
    image: mcr.microsoft.com/playwright:v1.58.0-jammy
    working_dir: /app/frontend
    command: sh -c "npm ci && count=0; while [ $$count -lt 30 ]; do if curl -fsS http://nginx/ > /dev/null; then break; fi; count=$$((count+1)); sleep 1; done; if [ $$count -eq 30 ]; then echo 'Timed out waiting for http://nginx/' >&2; exit 1; fi; npx playwright test"
    profiles:
      - test
    depends_on:
      - nginx
    environment:
      PLAYWRIGHT_BASE_URL: http://nginx
      PLAYWRIGHT_OUTPUT_DIR: /tmp/playwright-results
    volumes:
      - ./frontend/tests:/app/frontend/tests
      - ./frontend/playwright.config.js:/app/frontend/playwright.config.js
      - ./frontend/package.json:/app/frontend/package.json
      - ./frontend/package-lock.json:/app/frontend/package-lock.json
      - playwright-node-modules:/app/frontend/node_modules
      - playwright-results:/tmp/playwright-results

volumes:
  db-data:
  frontend-node-modules:
  playwright-node-modules:
  playwright-results:
